<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="appTitle">VoteImage Tool</title>
    <script defer data-domain="choisirlogo.enbauges.fr" src="https://psible.coolify.intrane.fr/js/script.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Basic styling for modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-button:hover { color: #666; }

        /* Styling for Logo Viewer Modal */
        .logo-viewer-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .logo-viewer-modal.visible {
            opacity: 1;
        }

        .logo-viewer-content {
            @apply w-auto h-auto max-w-[90vw] max-h-[70vh] md:max-w-3xl md:max-h-[80vh];
            object-fit: contain;
            cursor: default;
            margin-bottom: 1rem;
        }

        .logo-viewer-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            position: absolute; /* Position controls relative to modal */
            bottom: 2vh; /* Position at the bottom */
            z-index: 1001;
        }

        .logo-viewer-nav {
            @apply absolute top-1/2 -translate-y-1/2 bg-gray-800/60 text-white p-2 md:p-3 text-2xl md:text-3xl rounded;
            cursor: pointer;
            transition: background-color 0.3s;
            z-index: 1002;
        }
        .logo-viewer-nav:hover {
            background-color: rgba(80, 80, 80, 0.8);
        }
        .logo-viewer-prev {
            left: 2vw;
        }
        .logo-viewer-next {
            right: 2vw;
        }
        .logo-viewer-nav.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .logo-viewer-vote-btn {
            @apply bg-green-600 hover:bg-green-700 text-white font-bold px-6 py-3 rounded-lg;
            font-size: 1rem;
            transition: background-color 0.3s;
            margin: 0 10px;
        }
        @media (max-width: 640px) {
            .logo-viewer-vote-btn {
                @apply px-4 py-2 text-sm;
            }
        }

        .logo-viewer-close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
            z-index: 1001; /* Above the image */
        }

        /* --- NEW: Style for language switcher --- */
        .lang-switcher {
            @apply flex justify-end space-x-2 text-sm md:text-base;
        }
        .lang-switcher a {
            @apply px-2 py-1 rounded hover:bg-gray-100 transition-colors;
        }
        .lang-switcher a.active {
            @apply bg-blue-100 text-blue-800 hover:bg-blue-100;
        }
        /* --- END NEW --- */
    </style>
</head>
<body class="bg-gray-100 p-8 font-sans">

        <div class="lang-switcher mb-4 flex justify-end space-x-2">
            <a id="lang-en" class="px-3 py-1 rounded transition-colors duration-150 cursor-pointer">EN</a>
            <a id="lang-fr" class="px-3 py-1 rounded transition-colors duration-150 cursor-pointer">FR</a>
        </div>
        <div class="container mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-3xl font-bold mb-6 text-center text-blue-600 hover:text-blue-700 transition-colors duration-150" data-i18n="appTitle">VoteImage Tool</h1>

        <!-- Namespace Info with enhanced styling -->
        <div id="namespace-info" class="mb-6 p-6 bg-gradient-to-r from-blue-50 to-blue-100 border border-blue-200 rounded-lg shadow-sm">
            
            <div id="admin-controls-section" class="hidden mt-4 space-y-4">
                <h2 class="text-xl font-semibold mb-2" data-i18n="currentNamespace">Current Namespace</h2>
                <p id="current-namespace-id" class="mb-2 font-mono bg-gray-100 p-2 rounded">Loading...</p>
                <h3 class="font-semibold text-lg text-red-600" data-i18n="adminControls">Admin Controls</h3>
                <div>
                    <label for="friendly-url-input" class="block text-sm font-medium text-gray-700 mb-1" data-i18n="friendlyUrlLabel">Friendly URL Name:</label>
                    <div class="flex items-center space-x-2 md:flex-row flex-col-reverse gap-2">
                        <input type="text" id="friendly-url-input" data-i18n-placeholder="friendlyUrlPlaceholder" placeholder="e.g., my-cool-event" class="flex-grow p-2 border border-gray-300 rounded shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-sm md:text-base md:w-auto w-full">
                        <button id="set-friendly-url-btn" data-i18n="setFriendlyUrlBtn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">Set Name</button>
                    </div>
                    <p id="friendly-url-status" data-i18n-base="currentFriendlyUrl" class="mt-1 text-sm text-gray-600">Current: <span id="current-friendly-url" class="font-medium">None</span></p>
                </div>
                <div>
                    <button id="clear-votes-btn" data-i18n="clearVotesBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">Clear All Votes</button>
                    <button id="delete-namespace-btn" data-i18n="deleteNamespaceBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out">Delete This Namespace</button>
                </div>
            </div>
            <div id="namespace-links" class="hidden mt-6 space-y-3 bg-white p-4 rounded-lg shadow-sm">
                <h3 class="font-semibold text-lg" data-i18n="shareLinks">Share Links</h3>
                <div class="space-y-2">
                    <p class="flex flex-col md:flex-row md:items-center gap-2">
                        <strong class="md:w-24" data-i18n="votingLink">Voting Link:</strong>
                        <a id="voting-link" href="#" class="text-blue-500 hover:text-blue-600 break-all font-mono text-sm" target="_blank"></a>
                    </p>
                    <p id="friendly-link-p" class="hidden flex flex-col md:flex-row md:items-center gap-2">
                        <strong class="md:w-24" data-i18n="friendlyLink">Friendly Link:</strong>
                        <a id="friendly-link" href="#" class="text-purple-600 hover:text-purple-700 break-all font-mono text-sm" target="_blank"></a>
                    </p>
                    <p class="flex flex-col md:flex-row md:items-center gap-2">
                        <strong class="md:w-24" data-i18n="adminLink">Admin Link:</strong>
                        <a id="admin-link" href="#" class="text-red-500 hover:text-red-600 break-all font-mono text-sm" target="_blank"></a>
                        <span class="text-sm text-gray-600 italic" data-i18n="adminLinkNote">(Keep this safe!)</span>
                    </p>
                </div>
            </div>
        </div>

        <!-- Create Namespace Section -->
        <div id="create-namespace-section" class="mb-8 text-center">
            <p id="welcome-message" class="mb-6 text-lg text-gray-700" data-i18n="welcomeMessage">Welcome! Create a new voting namespace or access an existing one using the URL.</p>
            <button id="create-namespace-btn" class="primary-button text-lg px-6 py-3" data-i18n="createNamespaceBtn">Create New Vote Namespace</button>
        </div>

        <!-- Upload Section with enhanced styling -->
        <div id="upload-section" class="mb-8 hidden">
            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                <h2 class="text-xl font-semibold mb-4" data-i18n="uploadLogosTitle">Upload New Logo(s)</h2>
                <form id="upload-form" class="space-y-4">
                    <input type="file" id="logo-file-input" name="logoFiles" accept=".svg,.jpg,.jpeg,.png" required multiple 
                           class="block w-full text-sm text-gray-900 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                    <button type="submit" class="primary-button w-full md:w-auto" data-i18n="uploadBtn">Upload</button>
                </form>
                <p id="upload-status" class="mt-3 text-sm"></p>
            </div>
        </div>

        <!-- Logo Grid with enhanced styling -->
        <div id="logo-grid-section" class="hidden">
            <h2 class="text-xl font-semibold mb-6" data-i18n="voteOnLogosTitle">Vote on Logos</h2>
            <div id="logo-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <!-- Logos will be loaded here -->
            </div>
            <p id="no-logos-message" class="text-center text-gray-500 mt-8 hidden" data-i18n="noLogosMessage">No logos uploaded yet for this namespace.</p>
        </div>

        <!-- Identifier Modal -->
        <div id="identifier-modal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeModal()">&times;</span>
                <h3 class="text-lg font-semibold mb-3" data-i18n="identifierModalTitle">Enter Your Identifier</h3>
                <p class="text-sm mb-4 text-gray-600" data-i18n="identifierModalInfo">Please provide a unique identifier (e.g., email or phone number). We only use this to count votes and ensure one vote per logo within this namespace. It is stored securely.</p>
                <input type="text" id="identifier-input" data-i18n-placeholder="identifierPlaceholder" placeholder="Your email or phone" class="w-full p-2 border border-gray-300 rounded mb-4">
                <button id="submit-identifier-btn" data-i18n="submitIdentifierBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded w-full transition duration-150 ease-in-out">Submit and Vote</button>
                <p id="modal-error" class="text-red-500 text-sm mt-2"></p>
            </div>
        </div>

        <!-- Logo Viewer Modal -->
        <div id="logo-viewer-modal" class="logo-viewer-modal hidden">
            <span class="logo-viewer-close" id="logo-viewer-close-btn">&times;</span>
            <button id="logo-viewer-prev" class="logo-viewer-nav logo-viewer-prev">&#10094;</button>
            <img class="logo-viewer-content" id="logo-viewer-img">
            <button id="logo-viewer-next" class="logo-viewer-nav logo-viewer-next">&#10095;</button>
            <div class="logo-viewer-controls">
                 <button id="logo-viewer-vote-btn" data-i18n="logoViewerVoteBtn" class="logo-viewer-vote-btn">Vote for this Logo</button>
            </div>
        </div>

        <!-- Status Message Area -->
        <div id="status-message" class="mt-6 text-center font-medium status-message"></div>

    </div>

    <script>
        // --- I18N START ---
        const supportedLanguages = ['en', 'fr'];
        let currentLanguage = 'en';
        let translations = {};

        function getPreferredLanguage() {
            const storedLang = localStorage.getItem('preferredLanguage');
            if (storedLang && supportedLanguages.includes(storedLang)) {
                return storedLang;
            }
            const browserLang = navigator.language.split('-')[0];
            return supportedLanguages.includes(browserLang) ? browserLang : 'en';
        }

        async function loadTranslations(lang) {
            try {
                // Assuming locales are served relative to the HTML file's location
                const response = await fetch(`locales/${lang}.json`);
                if (!response.ok) {
                    throw new Error(`Could not load ${lang}.json`);
                }
                translations = await response.json();
                console.log(`Translations loaded for ${lang}`);
            } catch (error) {
                console.error('Error loading translations:', error);
                // Fallback to English if the requested language fails, unless English itself failed
                if (lang !== 'en') {
                    console.warn(`Falling back to English translations.`);
                    await loadTranslations('en');
                } else {
                    // If English fails, use keys as fallback
                    translations = {};
                }
            }
        }

        function t(key, params = {}) {
            let translation = translations[key] || key; // Fallback to key if not found
            for (const param in params) {
                translation = translation.replace(`{${param}}`, params[param]);
            }
            return translation;
        }

        function translatePage() {
            // Translate elements with data-i18n attribute
            document.querySelectorAll('[data-i18n]').forEach(element => {
                const key = element.getAttribute('data-i18n');
                element.textContent = t(key);
            });
            // Translate placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
                const key = element.getAttribute('data-i18n-placeholder');
                element.placeholder = t(key);
            });
            // Translate titles (tooltips)
            document.querySelectorAll('[data-i18n-title]').forEach(element => {
                const key = element.getAttribute('data-i18n-title');
                element.title = t(key);
            });
            // Translate elements with data-i18n-base (used for dynamic text like friendly URL status)
            document.querySelectorAll('[data-i18n-base]').forEach(element => {
                const key = element.getAttribute('data-i18n-base');
                const span = element.querySelector('span'); // Find the inner span to update
                if (span) {
                    // Reconstruct the text using the translated base and the existing span content
                    const baseText = t(key, { url: '' }).replace('{url}', ''); // Get base text without placeholder
                    element.textContent = baseText; // Set base text first
                    element.appendChild(span); // Re-append the span
                } else {
                    element.textContent = t(key);
                }
            });

            // Update language switcher active state
            document.querySelectorAll('.lang-switcher a').forEach(a => {
                a.classList.remove('active');
            });
            const activeLink = document.getElementById(`lang-${currentLanguage}`);
            if (activeLink) {
                activeLink.classList.add('active');
            }
            // Update HTML lang attribute
            document.documentElement.lang = currentLanguage;
        }

        async function setLanguage(lang) {
            if (!supportedLanguages.includes(lang)) {
                console.warn(`Unsupported language: ${lang}`);
                return;
            }
            currentLanguage = lang;
            localStorage.setItem('preferredLanguage', lang);
            await loadTranslations(lang);
            translatePage();
            if (currentNamespaceId) {
                await loadLogos();
                const currentStatusText = statusMessage.textContent;
                if (currentStatusText) {
                    console.warn("Status message might not be re-translated automatically on language change.");
                }
            }
        }
        // --- I18N END ---
        const apiUrl = ''; // Assuming backend is running on the same origin
        const logoGrid = document.getElementById('logo-grid');
        const uploadForm = document.getElementById('upload-form');
        const logoFileInput = document.getElementById('logo-file-input');
        const uploadStatus = document.getElementById('upload-status');
        const createNamespaceBtn = document.getElementById('create-namespace-btn');
        const namespaceInfoDiv = document.getElementById('namespace-info');
        const currentNamespaceIdP = document.getElementById('current-namespace-id');
        const uploadSection = document.getElementById('upload-section');
        const logoGridSection = document.getElementById('logo-grid-section');
        const createNamespaceSection = document.getElementById('create-namespace-section');
        const welcomeMessage = document.getElementById('welcome-message');
        const noLogosMessage = document.getElementById('no-logos-message');
        const statusMessage = document.getElementById('status-message');
        const adminControlsSection = document.getElementById('admin-controls-section');
        const clearVotesBtn = document.getElementById('clear-votes-btn');
        const deleteNamespaceBtn = document.getElementById('delete-namespace-btn');
        const namespaceLinksDiv = document.getElementById('namespace-links');
        const votingLinkA = document.getElementById('voting-link');
        const adminLinkA = document.getElementById('admin-link');
        const friendlyUrlInput = document.getElementById('friendly-url-input');
        const setFriendlyUrlBtn = document.getElementById('set-friendly-url-btn');
        const friendlyUrlStatus = document.getElementById('friendly-url-status');
        const currentFriendlyUrlSpan = document.getElementById('current-friendly-url');
        const friendlyLinkP = document.getElementById('friendly-link-p');
        const friendlyLinkA = document.getElementById('friendly-link');

        // Modal elements
        const identifierModal = document.getElementById('identifier-modal');
        const identifierInput = document.getElementById('identifier-input');
        const submitIdentifierBtn = document.getElementById('submit-identifier-btn');
        const modalError = document.getElementById('modal-error');
        let currentLogoIdToVote = null; // Store logo ID when modal opens

        // Logo Viewer Modal elements
        const logoViewerModal = document.getElementById('logo-viewer-modal');
        const logoViewerImg = document.getElementById('logo-viewer-img');
        const logoViewerCloseBtn = document.getElementById('logo-viewer-close-btn');
        const logoViewerPrevBtn = document.getElementById('logo-viewer-prev');
        const logoViewerNextBtn = document.getElementById('logo-viewer-next');
        const logoViewerVoteBtn = document.getElementById('logo-viewer-vote-btn');

        let currentNamespaceId = null;
        let currentAdminKey = null;
        let isAdmin = false;
        let displayedLogos = []; // To store the current list of logos
        let currentLogoIndex = -1; // Index of the logo currently shown in the viewer
        let currentFriendlyUrlName = null; // Store current friendly name
        let saveDescriptionDebounceTimers = {}; // Store debounce timers for description saving

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => { // Make async
            // --- I18N START ---
            currentLanguage = getPreferredLanguage();
            await loadTranslations(currentLanguage);
            // Attach language switcher listeners
            document.getElementById('lang-en').addEventListener('click', () => setLanguage('en'));
            document.getElementById('lang-fr').addEventListener('click', () => setLanguage('fr'));
            // --- I18N END ---
        
            const urlParams = new URLSearchParams(window.location.search);
            currentNamespaceId = urlParams.get('namespace');
            currentAdminKey = urlParams.get('admin'); // Might be null

            if (currentNamespaceId) {
                initializeNamespaceView();
            } else {
                showWelcomeView();
            }

            createNamespaceBtn.addEventListener('click', handleCreateNamespace);
            uploadForm.addEventListener('submit', handleUpload);
            submitIdentifierBtn.addEventListener('click', handleSubmitIdentifier);
            clearVotesBtn.addEventListener('click', handleClearVotes);
            deleteNamespaceBtn.addEventListener('click', handleDeleteNamespace);
            logoViewerCloseBtn.addEventListener('click', closeLogoViewer);
            logoViewerPrevBtn.addEventListener('click', showPreviousLogo);
            logoViewerNextBtn.addEventListener('click', showNextLogo);
            logoViewerVoteBtn.addEventListener('click', handleModalVoteClick);
            logoViewerModal.addEventListener('click', (event) => {
                if (event.target === logoViewerModal) {
                    closeLogoViewer();
                }
            });
            document.addEventListener('keydown', handleKeydown);
            setFriendlyUrlBtn.addEventListener('click', handleSetFriendlyUrl); // Add listener
        });

        function showWelcomeView() {
            namespaceInfoDiv.style.display = 'none';
            uploadSection.style.display = 'none';
            logoGridSection.style.display = 'none';
            createNamespaceSection.style.display = 'block';
            welcomeMessage.style.display = 'block';
            // --- I18N: Translate static elements shown in this view ---
            translatePage();
            // --- END I18N ---
        }

        async function initializeNamespaceView() {
            // --- I18N: Translate static elements shown in this view ---
            // Note: Dynamic text like namespace ID is set below,
            // and fetched data (logos) will be translated after fetch.
            translatePage();
            // --- END I18N ---
        
            currentNamespaceIdP.textContent = `Namespace ID: ${currentNamespaceId}`; // Keep this non-translated
            namespaceInfoDiv.style.display = 'block';
            uploadSection.style.display = 'block';
            logoGridSection.style.display = 'block';
            createNamespaceSection.style.display = 'none'; // Hide creation button
            welcomeMessage.style.display = 'none';

            // Check if admin key is present and potentially valid (backend confirms)
            isAdmin = !!currentAdminKey; // Assume admin if key exists, backend verifies actions
            if (isAdmin) {
                adminControlsSection.style.display = 'block';
                // --- MODIFICATION START ---
                // Show links if admin key is present in URL
                const baseUrl = window.location.origin + window.location.pathname;
                const votingUrl = `${baseUrl}?namespace=${currentNamespaceId}`;
                const adminUrl = `${baseUrl}?namespace=${currentNamespaceId}&admin=${currentAdminKey}`;

                votingLinkA.href = votingUrl;
                votingLinkA.textContent = votingUrl;
                adminLinkA.href = adminUrl;
                adminLinkA.textContent = adminUrl;
                namespaceLinksDiv.style.display = 'block';
                // --- MODIFICATION END ---
            } else {
                adminControlsSection.style.display = 'none';
                // Hide links if not admin
                namespaceLinksDiv.style.display = 'none'; // Keep this line for non-admin view
            }
            // namespaceLinksDiv.style.display = 'none'; // Hide links initially // REMOVED this line as logic is handled above

            await loadLogos(); // This will update currentFriendlyUrlName via processLogosResponse
        }

        // --- API Interaction ---

        async function fetchLogos(namespaceId) {
            try {
                const response = await fetch(`${apiUrl}/logos?namespace=${namespaceId}`);
                if (!response.ok) {
                    // Handle 404 specifically for namespace not found
                    if (response.status === 404) {
                              // --- I18N: Use translation key ---
                         setStatusMessage('statusNamespaceNotFound', true);
                         showWelcomeView(); // Go back to welcome if namespace invalid
                         return null; // Indicate failure clearly
                    }
                    throw new Error(`Failed to fetch logos: ${response.statusText}`);
                }
                return await response.json(); // Returns { logos: [], friendlyUrlName: "..." }
            } catch (error) {
                console.error('Error fetching logos:', error);
                 // --- I18N: Use translation key ---
                setStatusMessage('statusError', true, { message: `loading logos: ${error.message}` });
                return null; // Indicate failure
            }
        }

        async function loadLogos() {
            if (!currentNamespaceId) return;
            // --- I18N: Use translation key ---
            setStatusMessage('statusLoadingLogos', false);
            logoGrid.innerHTML = ''; // Clear existing logos
            noLogosMessage.style.display = 'none';
            displayedLogos = []; // Reset logo list

            const responseData = await fetchLogos(currentNamespaceId);

            // --- MODIFICATION START: Process response data ---
            if (responseData === null) {
                 // Error handled in fetchLogos, view might be reset
                 return;
            }

            processLogosResponse(responseData);
            // --- I18N: Translate newly added logo elements ---
            translatePage();
            // --- END I18N ---
            // --- MODIFICATION END ---
        }

        function createLogoElement(logo, index) { // Accept index
            const div = document.createElement('div');
            div.className = 'bg-white p-3 md:p-4 rounded-lg shadow hover:shadow-lg transition-shadow duration-200 ease-in-out relative flex flex-col';

            const img = document.createElement('img');
            const imgSrc = `${apiUrl}/data/uploads/${logo.path}`;
            img.src = imgSrc;
            img.alt = 'Logo Thumbnail';
            img.className = 'w-full h-32 md:h-40 object-contain mb-2 md:mb-3 cursor-pointer';
            img.onclick = () => openLogoViewer(index); // Pass index to openLogoViewer

            const voteCount = document.createElement('p');
            voteCount.textContent = `Votes: ${logo.votes}`;
            voteCount.className = 'text-center text-base md:text-lg font-semibold mb-1 md:mb-2';
            voteCount.id = `votes-${logo.id}`;

            // --- MODIFICATION: Add Description Display/Edit ---
            const descriptionContainer = document.createElement('div');
            descriptionContainer.className = 'mt-1 mb-2 md:mb-3 flex-grow';

            const descriptionDisplay = document.createElement('p');
            descriptionDisplay.id = `desc-display-${logo.id}`;
            descriptionDisplay.textContent = logo.description || 'No description yet.'; // Display current description
            descriptionDisplay.className = `text-sm text-gray-600 ${isAdmin ? 'hidden' : ''}`; // Hide if admin

            descriptionContainer.appendChild(descriptionDisplay);

            if (isAdmin) {
                const descriptionInput = document.createElement('textarea'); // Use textarea for potentially longer text
                descriptionInput.id = `desc-input-${logo.id}`;
                descriptionInput.value = logo.description || '';
                descriptionInput.placeholder = "Enter description...";
                descriptionInput.rows = 2; // Start with 2 rows
                descriptionInput.className = 'w-full p-1 border border-gray-300 rounded text-xs md:text-sm mb-1';
                // Add input event listener for debounced saving
                descriptionInput.addEventListener('input', () => handleDescriptionInput(logo.id));

                const descriptionStatus = document.createElement('p');
                descriptionStatus.id = `desc-status-${logo.id}`;
                descriptionStatus.className = 'text-xs text-gray-500 h-4'; // Height to prevent layout shift

                descriptionContainer.appendChild(descriptionInput);
                descriptionContainer.appendChild(descriptionStatus);
            }
            // --- END MODIFICATION ---

            const voteButton = document.createElement('button');
            voteButton.textContent = 'Vote';
            voteButton.className = 'w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-150 ease-in-out mt-auto'; // Added mt-auto
            voteButton.onclick = () => handleVoteClick(logo.id);

            div.appendChild(img);
            // --- MODIFICATION: Append description container ---
            div.appendChild(descriptionContainer);
            // --- END MODIFICATION ---
            div.appendChild(voteCount); // Moved vote count below description
            div.appendChild(voteButton);

            // Add delete button for admin
            if (isAdmin) {
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = '&times;'; // 'X' symbol
                deleteButton.className = 'absolute top-1 right-1 bg-red-500 hover:bg-red-700 text-white font-bold h-6 w-6 rounded-full flex items-center justify-center text-xs z-10'; // Added z-index
                deleteButton.title = 'Delete Logo';
                deleteButton.onclick = (e) => {
                    e.stopPropagation(); // Prevent triggering image click
                    handleDeleteLogo(logo.id);
                };
                div.appendChild(deleteButton);
            }

            return div;
        }

        // --- Event Handlers ---

        async function handleCreateNamespace() {
            setStatusMessage('Creating namespace...', false);
            try {
                const response = await fetch(`${apiUrl}/namespace`, { method: 'POST' });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `Failed to create namespace: ${response.statusText}`);
                }
                const data = await response.json();

                // --- MODIFICATION START ---
                // Update state before calling initializeNamespaceView
                currentNamespaceId = data.namespaceId;
                currentAdminKey = data.adminKey;
                isAdmin = true; // Creator is admin

                // Update URL without reloading - this makes initializeNamespaceView work correctly if called immediately
                const adminUrl = `${window.location.origin}${window.location.pathname}?namespace=${currentNamespaceId}&admin=${currentAdminKey}`;
                history.pushState({ namespaceId: currentNamespaceId, adminKey: currentAdminKey }, '', adminUrl);

                // Display links (will also be handled by initializeNamespaceView, but good for immediate feedback)
                // const baseUrl = window.location.origin + window.location.pathname; // Base URL already correct due to pushState
                // const votingUrl = `${baseUrl}?namespace=${data.namespaceId}`;
                // votingLinkA.href = votingUrl;
                // votingLinkA.textContent = votingUrl;
                // adminLinkA.href = adminUrl; // adminUrl already calculated
                // adminLinkA.textContent = adminUrl;
                // namespaceLinksDiv.style.display = 'block'; // This will be set by initializeNamespaceView

                // --- I18N: Use translation key ---
                setStatusMessage('statusNamespaceCreated', false);
                // --- MODIFICATION END ---

                // Optionally redirect to the new namespace admin view immediately
                // window.location.href = adminUrl; // Avoid redirect, use pushState and update view

                // Or just update the UI to reflect the new state without redirecting
                // currentNamespaceId = data.namespaceId; // Moved up
                // currentAdminKey = data.adminKey; // Moved up
                // isAdmin = true; // Creator is admin // Moved up
                initializeNamespaceView(); // Refresh view for the new namespace

            } catch (error) {
                console.error('Error creating namespace:', error);
                setStatusMessage(`Error: ${error.message}`, true);
                 namespaceLinksDiv.style.display = 'none'; // Hide links on error
            }
        }

        async function handleUpload(event) {
            event.preventDefault();
            if (!currentNamespaceId) {
                uploadStatus.textContent = 'Error: No namespace selected.';
                uploadStatus.className = 'mt-2 text-sm text-red-500';
                return;
            }
            if (!logoFileInput.files || logoFileInput.files.length === 0) {
                uploadStatus.textContent = 'Please select one or more files to upload.';
                 uploadStatus.className = 'mt-2 text-sm text-yellow-600';
                return;
            }

            const fileCount = logoFileInput.files.length;
            uploadStatus.textContent = `Uploading ${fileCount} file(s)...`;
            uploadStatus.className = 'mt-2 text-sm text-blue-600';

            try {
                const formData = new FormData();
                for (let i = 0; i < logoFileInput.files.length; i++) {
                     formData.append('logoFiles', logoFileInput.files[i]); // Use the name matching backend array
                }
                // Alternatively, simpler:
                // const formData = new FormData(uploadForm); // If input name is correct

                const response = await fetch(`${apiUrl}/upload?namespace=${currentNamespaceId}`, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                // --- MODIFICATION: Handle different success/error statuses ---
                if (!response.ok && response.status !== 207) { // 207 is partial success
                    throw new Error(result.message || `Upload failed: ${response.statusText}`);
                }

                // Handle full or partial success
                if (response.status === 201) { // All successful
                     uploadStatus.textContent = `Success: ${result.message}`;
                     uploadStatus.className = 'mt-2 text-sm text-green-600';
                } else if (response.status === 207) { // Partial success
                     uploadStatus.textContent = `Partial Success: ${result.message}`;
                     uploadStatus.className = 'mt-2 text-sm text-yellow-600';
                     // Optionally display more details about errors from result.errors
                     console.warn("Upload errors:", result.errors);
                } else {
                     // Should be caught by the !response.ok check, but as a fallback
                     uploadStatus.textContent = `Success: ${result.message || 'Upload processed.'}`;
                     uploadStatus.className = 'mt-2 text-sm text-green-600';
                }

                logoFileInput.value = ''; // Clear the input
                await loadLogos(); // Refresh the grid
                // --- END MODIFICATION ---

            } catch (error) {
                console.error('Upload error:', error);
                // --- I18N: Use translation key ---
                uploadStatus.textContent = t('statusUploadError', { message: error.message });
                uploadStatus.className = 'mt-2 text-sm text-red-500';
            }
        }

        function handleVoteClick(logoId) {
            const identifierKey = `namespace-${currentNamespaceId}-identifier`;
            const storedIdentifier = localStorage.getItem(identifierKey);

            if (storedIdentifier) {
                // Identifier exists, proceed to vote directly
                submitVote(logoId, storedIdentifier);
            } else {
                // No identifier stored for this namespace, open modal
                currentLogoIdToVote = logoId; // Store which logo is being voted on
                openModal();
            }
        }

        function handleSubmitIdentifier() {
            const identifier = identifierInput.value.trim();
            if (!identifier) {
                modalError.textContent = 'Identifier cannot be empty.';
                return;
            }
            if (!currentLogoIdToVote) {
                 modalError.textContent = 'Error: No logo selected for voting.';
                 return;
            }

            modalError.textContent = ''; // Clear previous errors

            // Encode identifier (simple Base64 for this example)
            const encodedIdentifier = btoa(identifier); // Base64 encode

            // Store identifier in localStorage, scoped to namespace
            const identifierKey = `namespace-${currentNamespaceId}-identifier`;
            localStorage.setItem(identifierKey, encodedIdentifier);

            // Close modal and submit the vote
            closeModal();
            submitVote(currentLogoIdToVote, encodedIdentifier);
            identifierInput.value = ''; // Clear input
            currentLogoIdToVote = null; // Reset
        }

        async function submitVote(logoId, identifier) {
             if (!currentNamespaceId) return;
             setStatusMessage('Submitting vote...', false);

            try {
                const response = await fetch(`${apiUrl}/vote?namespace=${currentNamespaceId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ logoId, identifier }),
                });

                const result = await response.json();

                if (!response.ok) {
                     // Handle specific conflict case (already voted)
                    if (response.status === 409) {
                         setStatusMessage(result.message || 'You have already voted for this logo.', true);
                    } else {
                        throw new Error(result.message || `Vote failed: ${response.statusText}`);
                    }
                } else {
                    setStatusMessage('Vote recorded!', false);
                    // Update vote count display dynamically IN THE GRID
                    const voteCountElement = document.getElementById(`votes-${logoId}`);
                    if (voteCountElement) {
                        voteCountElement.textContent = `Votes: ${result.votes}`;
                    }
                     // Update the stored logo data as well, so cycling shows correct count if we re-fetch later
                     const logoIndex = displayedLogos.findIndex(l => l.id === logoId);
                     if (logoIndex !== -1) {
                         // Note: This assumes the identifier wasn't already present.
                         // A more robust approach might re-fetch the specific logo's data.
                         displayedLogos[logoIndex].votes = result.votes;
                     }
                }

            } catch (error) {
                console.error('Vote error:', error);
                setStatusMessage(`Error: ${error.message}`, true);
            }
        }

        // --- Admin Actions ---

        async function handleDeleteLogo(logoId) {
            if (!isAdmin || !currentAdminKey || !currentNamespaceId) return;

            if (!confirm(`Are you sure you want to delete logo ${logoId}? This cannot be undone.`)) {
                return;
            }

            setStatusMessage('Deleting logo...', false);
            try {
                const response = await fetch(`${apiUrl}/logo?namespace=${currentNamespaceId}&logoId=${logoId}&admin=${currentAdminKey}`, {
                    method: 'DELETE',
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || `Failed to delete logo: ${response.statusText}`);
                }
                setStatusMessage('Logo deleted successfully.', false);
                await loadLogos(); // Refresh grid
            } catch (error) {
                console.error('Error deleting logo:', error);
                setStatusMessage(`Error: ${error.message}`, true);
            }
        }

        async function handleClearVotes() {
             if (!isAdmin || !currentAdminKey || !currentNamespaceId) return;

            if (!confirm('Are you sure you want to clear ALL votes for this namespace? This cannot be undone.')) {
                return;
            }

            setStatusMessage('Clearing votes...', false);
            try {
                const response = await fetch(`${apiUrl}/clear-votes?namespace=${currentNamespaceId}&admin=${currentAdminKey}`, {
                    method: 'POST',
                });
                 const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || `Failed to clear votes: ${response.statusText}`);
                }
                setStatusMessage('All votes cleared successfully.', false);
                await loadLogos(); // Refresh grid to show zero votes
            } catch (error) {
                console.error('Error clearing votes:', error);
                setStatusMessage(`Error: ${error.message}`, true);
            }
        }

        async function handleDeleteNamespace() {
             if (!isAdmin || !currentAdminKey || !currentNamespaceId) return;

            if (!confirm('WARNING: Are you sure you want to delete this ENTIRE namespace, including all logos and votes? This cannot be undone.')) {
                return;
            }

             setStatusMessage('Deleting namespace...', false);
            try {
                const response = await fetch(`${apiUrl}/namespace?namespace=${currentNamespaceId}&admin=${currentAdminKey}`, {
                    method: 'DELETE',
                });
                 const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message || `Failed to delete namespace: ${response.statusText}`);
                }
                setStatusMessage('Namespace deleted successfully. Redirecting...', false);
                // Redirect to home page after deletion
                setTimeout(() => {
                    window.location.href = window.location.origin + window.location.pathname;
                }, 2000);

            } catch (error) {
                console.error('Error deleting namespace:', error);
                setStatusMessage(`Error: ${error.message}`, true);
            }
        }

        // --- Logo Viewer Modal Control ---
        function openLogoViewer(index) {
            if (index < 0 || index >= displayedLogos.length) return;
            currentLogoIndex = index;
            showLogoAtIndex(currentLogoIndex);
            logoViewerModal.style.display = "flex"; // Show the modal using flex
            document.body.style.overflow = 'hidden'; // Prevent body scrolling
        }

        function closeLogoViewer() {
            logoViewerModal.style.display = "none"; // Hide the modal
            logoViewerImg.src = ""; // Clear src
            currentLogoIndex = -1; // Reset index
            document.body.style.overflow = ''; // Restore body scrolling
        }

        function showLogoAtIndex(index) {
            if (index < 0 || index >= displayedLogos.length) return;

            currentLogoIndex = index;
            const logo = displayedLogos[index];
            logoViewerImg.src = `${apiUrl}/data/uploads/${logo.path}`;
            logoViewerImg.alt = `Logo ${index + 1}`;

            // Update button states
            logoViewerPrevBtn.classList.toggle('disabled', index === 0);
            logoViewerNextBtn.classList.toggle('disabled', index === displayedLogos.length - 1);
        }

        function showPreviousLogo() {
            if (currentLogoIndex > 0) {
                showLogoAtIndex(currentLogoIndex - 1);
            }
        }

        function showNextLogo() {
            if (currentLogoIndex < displayedLogos.length - 1) {
                showLogoAtIndex(currentLogoIndex + 1);
            }
        }

        function handleModalVoteClick() {
            if (currentLogoIndex !== -1 && currentLogoIndex < displayedLogos.length) {
                const logoId = displayedLogos[currentLogoIndex].id;
                handleVoteClick(logoId); // Reuse existing vote logic
            }
        }

        function handleKeydown(event) {
             // Only act if the logo viewer modal is visible
            if (logoViewerModal.style.display === 'flex') {
                if (event.key === 'ArrowLeft') {
                    showPreviousLogo();
                } else if (event.key === 'ArrowRight') {
                    showNextLogo();
                } else if (event.key === 'Escape') {
                    closeLogoViewer();
                }
            }
        }

        // --- Modal Control ---
        function openModal() {
            modalError.textContent = ''; // Clear errors on open
            identifierModal.style.display = 'block';
        }

        function closeModal() {
            identifierModal.style.display = 'none';
        }

        // Close modal if user clicks outside of it
        window.onclick = function(event) {
            if (event.target == identifierModal) {
                closeModal();
            }
            // Close logo viewer if clicking background (added this check here)
            // Check if the click is directly on the modal background, not children
            if (event.target == logoViewerModal) {
                 closeLogoViewer();
            }
        }

        // --- Utility ---
        function setStatusMessage(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = `mt-6 text-center font-medium ${isError ? 'text-red-600' : 'text-green-600'}`;
        }

        // --- MODIFICATION START: New function to process logo/namespace data ---
        function processLogosResponse(responseData) {
             const logos = responseData.logos || [];
             currentFriendlyUrlName = responseData.friendlyUrlName || null; // Update global state

             // --- MODIFICATION: Ensure description is part of the logo object ---
             displayedLogos = logos.map(logo => ({
                 ...logo,
                 description: logo.description || "" // Ensure description exists
             }));
             // --- END MODIFICATION ---

             if (logos.length === 0) {
                noLogosMessage.style.display = 'block';
                 setStatusMessage('', false);
            } else {
                 noLogosMessage.style.display = 'none';
                 logoGrid.innerHTML = ''; // Clear grid before adding new elements
                displayedLogos.forEach((logo, index) => { // Use updated displayedLogos
                    const logoElement = createLogoElement(logo, index);
                    logoGrid.appendChild(logoElement);
                });
                 setStatusMessage('', false);
            }

            // Update friendly URL display elements after processing
            updateFriendlyUrlDisplay();
            // --- I18N: Translate elements updated by this function ---
            translatePage();
            // --- END I18N ---
        }
        // --- MODIFICATION END ---

        // --- MODIFICATION START: New function to update friendly URL UI elements ---
        function updateFriendlyUrlDisplay() {
             if (isAdmin) { // Only show input/current if admin
                 friendlyUrlInput.value = currentFriendlyUrlName || '';
                 currentFriendlyUrlSpan.textContent = currentFriendlyUrlName || 'None';
             }

             // Update share link visibility and content
             if (currentFriendlyUrlName) {
                 const friendlyUrl = `${window.location.origin}/v/${currentFriendlyUrlName}`;
                 friendlyLinkA.href = friendlyUrl;
                 friendlyLinkA.textContent = friendlyUrl;
                 friendlyLinkP.style.display = 'block';
             } else {
                 friendlyLinkP.style.display = 'none';
             }
             // --- I18N: Translate elements updated by this function ---
             // (Specifically the 'Current: {url}' part)
             translatePage();
             // --- END I18N ---
        }
        // --- MODIFICATION END ---

        // --- MODIFICATION START: Add handler for setting friendly URL ---
        async function handleSetFriendlyUrl() {
            if (!isAdmin || !currentNamespaceId || !currentAdminKey) return;

            const desiredName = friendlyUrlInput.value; // Get value from input

            setStatusMessage('Setting friendly URL...', false);
            // --- I18N: Use translation key ---
            friendlyUrlStatus.textContent = t('loading'); // Indicate updating
            friendlyUrlStatus.className = 'mt-1 text-sm text-gray-600';

            try {
                const response = await fetch(`${apiUrl}/namespace/friendly-url?namespace=${currentNamespaceId}&admin=${currentAdminKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ friendlyName: desiredName }), // Send the raw desired name
                });

                const result = await response.json();

                if (!response.ok) {
                    // Handle specific conflict error
                    if (response.status === 409) {
                         const errorMessage = result.message || 'Failed to set friendly URL.';
                         friendlyUrlStatus.textContent = t('statusFriendlyUrlError', { message: errorMessage });
                         friendlyUrlStatus.className = 'mt-1 text-sm text-red-600';
                    } else {
                        throw new Error(result.message || `Failed to set friendly URL: ${response.statusText}`);
                    }
                     setStatusMessage(`Error: ${result.message || 'Failed to set friendly URL.'}`, true); // General status
                } else {
                    setStatusMessage('Friendly URL updated!', false); // General status
                    friendlyUrlStatus.textContent = `Current: ${result.friendlyUrlName || 'None'}`; // Specific status
                    friendlyUrlStatus.className = 'mt-1 text-sm text-gray-600';
                    currentFriendlyUrlName = result.friendlyUrlName || null; // Update state
                    updateFriendlyUrlDisplay(); // Refresh links and input
                }

            } catch (error) {
                console.error('Error setting friendly URL:', error);
                setStatusMessage(`Error: ${error.message}`, true); // General status
                friendlyUrlStatus.textContent = `Error: ${error.message}`; // Specific status
                friendlyUrlStatus.className = 'mt-1 text-sm text-red-600';
            }
        }
        // --- MODIFICATION END ---

        // --- MODIFICATION START: Add Description Input Handler (Debounced Save) ---
        function handleDescriptionInput(logoId) {
            const statusElement = document.getElementById(`desc-status-${logoId}`);
            if (statusElement) {
                statusElement.textContent = 'Saving...';
                statusElement.className = 'text-xs text-blue-600 h-4';
            }

            // Clear existing timer for this logoId
            if (saveDescriptionDebounceTimers[logoId]) {
                clearTimeout(saveDescriptionDebounceTimers[logoId]);
            }

            // Set a new timer
            saveDescriptionDebounceTimers[logoId] = setTimeout(() => {
                handleSaveDescription(logoId);
            }, 1500); // Debounce time: 1.5 seconds
        }
        // --- END MODIFICATION ---

        // --- MODIFICATION START: Add Save Description Handler ---
        async function handleSaveDescription(logoId) {
            if (!isAdmin || !currentAdminKey || !currentNamespaceId) return;

            const inputElement = document.getElementById(`desc-input-${logoId}`);
            const statusElement = document.getElementById(`desc-status-${logoId}`);
            const description = inputElement ? inputElement.value : '';

            // No need for setStatusMessage here, use the local status element
            if (statusElement) {
                 statusElement.textContent = 'Saving...';
                 statusElement.className = 'text-xs text-blue-600 h-4';
            }

            try {
                const response = await fetch(`${apiUrl}/logo/description?namespace=${currentNamespaceId}&logoId=${logoId}&admin=${currentAdminKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ description: description }),
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || `Failed to save description: ${response.statusText}`);
                }

                if (statusElement) {
                    statusElement.textContent = 'Saved!';
                    statusElement.className = 'text-xs text-green-600 h-4';
                    // Optionally clear the 'Saved!' message after a delay
                    setTimeout(() => {
                         if (statusElement.textContent === 'Saved!') {
                             statusElement.textContent = '';
                         }
                    }, 3000);
                }
                // Update the internal data store if needed (optional, as loadLogos refetches)
                const logoIndex = displayedLogos.findIndex(l => l.id === logoId);
                if (logoIndex !== -1) {
                    displayedLogos[logoIndex].description = result.description;
                }

            } catch (error) {
                console.error('Error saving description:', error);
                if (statusElement) {
                    statusElement.textContent = `Error: ${error.message}`;
                    statusElement.className = 'text-xs text-red-600 h-4';
                }
                // Use general status message for broader errors
                setStatusMessage(`Error saving description for logo ${logoId}: ${error.message}`, true);
            }
        }
        // --- END MODIFICATION ---

    </script>
</body>
</html>